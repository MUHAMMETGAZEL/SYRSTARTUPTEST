<!--
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خريطة منظومة الابتكار في سوريا - Startup Syria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(76, 161, 175, 0.3);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b, #4ca1af, #2c3e50, #9d4edd);
        }
        
        .header h1 {
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(76, 161, 175, 0.7);
        }
        
        .header h2 {
            color: #4ca1af;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .header p {
            color: #a8dadc;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .map-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            position: relative;
            margin: 30px auto;
            max-width: 1200px;
            width: 100%;
            height: 85vh;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(76, 161, 175, 0.3);
        }
        
        #flourish-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .flourish-embed {
            width: 100%;
            height: 100%;
            border: none;
            transform-origin: center;
            transition: transform 0.3s ease;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 30, 50, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            z-index: 10;
            border: 1px solid rgba(76, 161, 175, 0.5);
        }
        
        .legend h3 {
            color: #ffd166;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .legend-text {
            font-size: 1rem;
            color: #a8dadc;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: #a8dadc;
            font-size: 1.1rem;
            border: 1px solid rgba(76, 161, 175, 0.3);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .highlight {
            color: #4ca1af;
            font-weight: 600;
            text-shadow: 0 0 8px rgba(76, 161, 175, 0.7);
        }
        
        .title-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto 20px;
        }
        
        .title-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #a8dadc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .title-box i {
            font-size: 1.4rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4ca1af;
            color: #a8dadc;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-btn:hover {
            background: rgba(76, 161, 175, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(76, 161, 175, 0.5);
        }
        
        .statistics {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            min-width: 150px;
            text-align: center;
            border: 1px solid rgba(76, 161, 175, 0.3);
            transition: all 0.3s ease;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(76, 161, 175, 0.3);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4ca1af;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(76, 161, 175, 0.5);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #a8dadc;
        }
        
        .description {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            text-align: center;
            color: #a8dadc;
            line-height: 1.6;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #4ca1af;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: #a8dadc;
        }
        
        .zoom-level {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 30, 50, 0.8);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1.1rem;
            color: #ffd166;
            z-index: 10;
            display: none;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header h2 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .map-container {
                height: 75vh;
            }
            
            .title-box {
                font-size: 1rem;
                padding: 8px 15px;
            }
            
            .legend {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .map-container {
                height: 65vh;
            }
            
            .legend {
                position: relative;
                width: 90%;
                margin: 10px auto;
                bottom: auto;
                left: auto;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 90%;
            }
            
            .title-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header h2 {
                font-size: 1.3rem;
            }
        }
        
        .tooltip {
            position: absolute;
            background: rgba(20, 30, 50, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            pointer-events: none;
            font-size: 1.1rem;
            border: 1px solid #4ca1af;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <div class="title-row">
        <div class="title-box">
            <i class="fas fa-question-circle"></i>
            <span>Question Support</span>
        </div>
        <div class="title-box">
            <i class="fas fa-flag"></i>
            <span>Strategy Syria</span>
        </div>
    </div>
    
    <div class="header">
        <h1>خريطة منظومة الابتكار في سوريا</h1>
        <h2>Startup Syria</h2>
        <p>تم تحديث الخريطة باستخدام منصة Flourish المتقدمة لتقديم تجربة تفاعلية متكاملة</p>
    </div>
    
    <div class="controls">
        <button class="control-btn" id="fullscreen-btn">
            <i class="fas fa-expand"></i>
            <span>عرض كامل الشاشة</span>
        </button>
        <button class="control-btn" id="reset-view">
            <i class="fas fa-sync-alt"></i>
            <span>إعادة تعيين العرض</span>
        </button>
        <button class="control-btn" id="zoom-in-btn">
            <i class="fas fa-search-plus"></i>
            <span>تكبير</span>
        </button>
        <button class="control-btn" id="zoom-out-btn">
            <i class="fas fa-search-minus"></i>
            <span>تصغير</span>
        </button>
    </div>
    
    <div class="map-container">
        <div class="loading-overlay" id="loading-overlay">
            <div class="loader"></div>
            <div class="loading-text">جاري تحميل الخريطة التفاعلية...</div>
        </div>
        <div class="tooltip"></div>
        <div class="zoom-level" id="zoom-level">التكبير: 100%</div>
        
        
        <div id="flourish-container">
            <div class="flourish-embed flourish-hierarchy" data-src="visualisation/24076143">
                <script src="https://public.flourish.studio/resources/embed.js"></script>
            </div>
        </div>
    </div>
    
    <div class="description">
        <p>تقدم هذه الخريطة التفاعلية رؤية شاملة لمنظومة الابتكار في سوريا، حيث يمكنك استكشاف مختلف المكونات والعلاقات بين الجهات الفاعلة في النظام البيئي للابتكار. استخدم أدوات التحكم للتفاعل مع الخريطة واستكشاف البيانات.</p>
    </div>
    
    <div class="statistics">
        <div class="stat-box">
            <div class="stat-value">42</div>
            <div class="stat-label">منظمة داعمة</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">18</div>
            <div class="stat-label">حاضنة أعمال</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">127</div>
            <div class="stat-label">مشروع ناشئ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">$5.2M</div>
            <div class="stat-label">استثمارات</div>
        </div>
    </div>
    
    <div class="footer">
        <p>Source: <span class="highlight">Data Collected by Startup Syria 2025</span> | Powered by <span class="highlight">Flourish Studio</span></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapContainer = document.querySelector('.map-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const tooltip = document.querySelector('.tooltip');
            const zoomLevel = document.getElementById('zoom-level');
            const flourishContainer = document.getElementById('flourish-container');
            const flourishEmbed = document.querySelector('.flourish-embed');
            
            
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500);
            }, 2000);
            
            
            document.getElementById('fullscreen-btn').addEventListener('click', function() {
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.mozRequestFullScreen) { // Firefox
                    mapContainer.mozRequestFullScreen();
                } else if (mapContainer.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    mapContainer.webkitRequestFullscreen();
                } else if (mapContainer.msRequestFullscreen) { // IE/Edge
                    mapContainer.msRequestFullscreen();
                }
            });
            
           
            document.getElementById('reset-view').addEventListener('click', function() {
                
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.opacity = '1';
                
                
                flourishEmbed.style.transform = 'scale(1)';
                
                
                zoomLevel.textContent = 'التكبير: 100%';
                zoomLevel.style.display = 'block';
                
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                    
                   
                    setTimeout(() => {
                        zoomLevel.style.display = 'none';
                    }, 2000);
                }, 1000);
            });
            
          
            document.getElementById('zoom-in-btn').addEventListener('click', function() {
                let currentScale = parseFloat(flourishEmbed.style.transform.replace('scale(', '').replace(')', '')) || 1;
                if (currentScale < 2) {
                    currentScale += 0.1;
                    flourishEmbed.style.transform = `scale(${currentScale})`;
                    
                    
                    zoomLevel.textContent = `التكبير: ${Math.round(currentScale * 100)}%`;
                    zoomLevel.style.display = 'block';
                    
                   
                    setTimeout(() => {
                        zoomLevel.style.display = 'none';
                    }, 2000);
                } else {
                    tooltip.innerHTML = '<strong>الحد الأقصى للتكبير</strong><br>لا يمكن التكبير أكثر من ذلك';
                    tooltip.style.opacity = 1;
                    tooltip.style.left = '50%';
                    tooltip.style.top = '50%';
                    tooltip.style.transform = 'translate(-50%, -50%)';
                    
                    setTimeout(() => {
                        tooltip.style.opacity = 0;
                    }, 1500);
                }
            });
            
            
            document.getElementById('zoom-out-btn').addEventListener('click', function() {
                let currentScale = parseFloat(flourishEmbed.style.transform.replace('scale(', '').replace(')', '')) || 1;
                if (currentScale > 0.5) {
                    currentScale -= 0.1;
                    flourishEmbed.style.transform = `scale(${currentScale})`;
                    
                    
                    zoomLevel.textContent = `التكبير: ${Math.round(currentScale * 100)}%`;
                    zoomLevel.style.display = 'block';
                    
                    
                    setTimeout(() => {
                        zoomLevel.style.display = 'none';
                    }, 2000);
                } else {
                    tooltip.innerHTML = '<strong>الحد الأدنى للتصغير</strong><br>لا يمكن التصغير أكثر من ذلك';
                    tooltip.style.opacity = 1;
                    tooltip.style.left = '50%';
                    tooltip.style.top = '50%';
                    tooltip.style.transform = 'translate(-50%, -50%)';
                    
                    setTimeout(() => {
                        tooltip.style.opacity = 0;
                    }, 1500);
                }
            });
            
            // Initialize tooltip position on mouse move
            document.addEventListener('mousemove', function(e) {
                if (tooltip.style.opacity === '1') {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 30) + 'px';
                }
            });
            
            
            flourishContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                let currentScale = parseFloat(flourishEmbed.style.transform.replace('scale(', '').replace(')', '')) || 1;
                
                if (e.deltaY < 0) {
                    // تكبير
                    if (currentScale < 2) {
                        currentScale += 0.1;
                        flourishEmbed.style.transform = `scale(${currentScale})`;
                    }
                } else {
                    // تصغير
                    if (currentScale > 0.5) {
                        currentScale -= 0.1;
                        flourishEmbed.style.transform = `scale(${currentScale})`;
                    }
                }
                
               
                zoomLevel.textContent = `التكبير: ${Math.round(currentScale * 100)}%`;
                zoomLevel.style.display = 'block';
                
                setTimeout(() => {
                    zoomLevel.style.display = 'none';
                }, 2000);
            });
        });
    </script>
</body>
</html>
-->



<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <title>خريطة منظومة الابتكار في سوريا - Startup Syria</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        color: #fff;
        overflow-x: hidden;
    }
    
    .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(76, 161, 175, 0.3);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #ff7e5f, #feb47b, #4ca1af, #2c3e50, #9d4edd);
    }
    
    .header h1 {
        color: #fff;
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
        text-shadow: 0 0 15px rgba(76, 161, 175, 0.7);
    }
    
    .header h2 {
        color: #4ca1af;
        font-size: 1.8rem;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .header p {
        color: #a8dadc;
        font-size: 1.1rem;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
    }
    
    .map-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
        position: relative;
        margin: 30px auto;
        max-width: 800px;
        width: 100%;
        height: 80vh;
        perspective: 1000px;
    }
    
    #concentric-map {
        width: 100%;
        height: 100%;
        position: relative;
        transition: transform 0.8s ease-in-out;
    }
    
    .center-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, #4ca1af, #2c3e50);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        text-align: center;
        box-shadow: 
            0 0 30px rgba(76, 161, 175, 0.8),
            inset 0 0 20px rgba(0, 0, 0, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
        z-index: 100;
        animation: pulse 3s infinite;
        transition: all 0.5s ease;
    }
    
    .center-circle h3 {
        font-size: 1rem;
        margin-bottom: 5px;
        color: #ffd166;
    }
    
    .center-circle p {
        font-size: 0.9rem;
        padding: 0 15px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(76, 161, 175, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(76, 161, 175, 0); }
        100% { box-shadow: 0 0 0 0 rgba(76, 161, 175, 0); }
    }
    
    .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .control-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #4ca1af;
        color: #a8dadc;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .control-btn:hover {
        background: rgba(76, 161, 175, 0.3);
        transform: translateY(-2px);
    }
    
    .control-btn i {
        font-size: 1.2rem;
    }
    
    .statistics {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .stat-box {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 10px;
        min-width: 150px;
        text-align: center;
        border: 1px solid rgba(76, 161, 175, 0.3);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #4ca1af;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #a8dadc;
    }
    
    .subsection-item {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .subsection-item:hover {
        opacity: 1 !important;
        filter: brightness(1.2);
    }
    
    .rotation-controls {
        display: flex;
        gap: 10px;
    }
    
    .rotation-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(76, 161, 175, 0.3);
        border: 1px solid #4ca1af;
        color: #a8dadc;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .rotation-btn:hover {
        background: rgba(76, 161, 175, 0.5);
        transform: scale(1.1);
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    .modal.active {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: linear-gradient(135deg, #1b263b 0%, #0d1b2a 100%);
        width: 90%;
        max-width: 500px;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(76, 161, 175, 0.5);
        position: relative;
        transform: translateY(-20px);
        transition: all 0.4s ease;
    }
    .modal.active .modal-content {
        transform: translateY(0);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(76, 161, 175, 0.3);
    }
    .modal-title {
        color: #ffd166;
        font-size: 1.8rem;
        font-weight: 700;
    }
    .close-btn {
        background: transparent;
        border: none;
        color: #a8dadc;
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .close-btn:hover {
        color: #ff7e5f;
        transform: rotate(90deg);
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 10px;
        color: #a8dadc;
        font-size: 1.1rem;
    }
    .form-group input, .form-group textarea, .form-group select {
        width: 100%;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #4ca1af;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        border-color: #ffd166;
        box-shadow: 0 0 10px rgba(255, 209, 102, 0.3);
        outline: none;
    }
    .form-group textarea {
        height: 120px;
        resize: vertical;
    }
    .form-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 25px;
    }
    .form-btn {
        flex: 1;
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .form-btn.primary {
        background: linear-gradient(135deg, #4ca1af, #2c3e50);
        color: white;
    }
    .form-btn.primary:hover {
        background: linear-gradient(135deg, #3d8c99, #1b263b);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .form-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #a8dadc;
        border: 1px solid #4ca1af;
    }  
    .form-btn.secondary:hover {
        background: rgba(76, 161, 175, 0.2);
        transform: translateY(-3px);
    }
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(76, 161, 175, 0.9);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 3000;
        display: none;
        animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 2.5s;
        max-width: 350px;
    }
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }
    .notification-content {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .notification-icon {
        font-size: 2rem;
        color: #ffd166;
    }
    .notification-text h3 {
        margin-bottom: 5px;
        font-size: 1.2rem;
    }
    .notification-text p {
        font-size: 1rem;
        opacity: 0.9;
    }
    .section-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid rgba(76, 161, 175, 0.3);
        border-radius: 8px;
        padding: 10px;
    }
    .section-item {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }   
    .section-item:hover {
        background: rgba(76, 161, 175, 0.2);
        transform: translateX(-5px);
    }
    .section-item.active {
        background: rgba(76, 161, 175, 0.3);
        border-left: 4px solid #ffd166;
    }        
    .section-name {
        font-weight: 600;
        color: #a8dadc;
    }
    .section-id {
        background: rgba(255, 209, 102, 0.2);
        color: #ffd166;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    .section-link {
        font-size: 0.85rem;
        color: #4ca1af;
        margin-top: 5px;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        direction: ltr;
        text-align: left;
    }
    .link-icon {
        color: #ff7e5f;
        margin-left: 5px;
    }
    .link-button {
        cursor: pointer;
        transition: all 0.3s ease;
        pointer-events: all;
    }
    .link-icon {
        font-size: 14px;
        fill: #4ca1af;
        transition: all 0.3s ease;
    }
    .link-button:hover .link-icon {
        fill: #ffd166;
        transform: scale(1.2);
    }
    .link-icon-text {
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: 14px;
        fill: #4ca1af;
        transition: all 0.3s ease;
    }   
    .database-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        font-size: 0.9rem;
        color: #4ca1af;
    }
    .db-icon {
        color: #ffd166;
    }
    .title-row {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 800px;
        margin: 0 auto 20px;
    }
    .title-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #a8dadc;
    }
    .subsection-label {
        position: absolute;
        text-align: center;
        font-size: 10px;
        font-weight: bold;
        z-index: 80;
        pointer-events: none;
        fill: #ffffff;
        text-shadow: 0 0 2px rgba(0,0,0,0.8);
    }
    .inner-label {
        position: absolute;
        text-align: center;
        font-size: 13px;
        font-weight: bold;
        z-index: 90;
        pointer-events: none;
        line-height: 1.3;
    }
    .license-control {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
    }
    .license-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #4ca1af;
        color: white;
        padding: 10px 15px;
        border-radius: 30px;
        width: 200px;
        text-align: center;
        font-size: 1rem;
        transition: all 0.3s ease;
        margin-right: 10px;
    }
    .license-input:focus {
        border-color: #ffd166;
        box-shadow: 0 0 10px rgba(255, 209, 102, 0.3);
        outline: none;
    } 
    .license-btn {
        background: linear-gradient(135deg, #4ca1af, #2c3e50);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    .license-btn:hover {
        background: linear-gradient(135deg, #3d8c99, #1b263b);
        transform: translateY(-2px);
    }       
    .license-status {
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
        padding: 8px 16px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(76, 161, 175, 0.2);
        display: inline-block;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }
    .license-active {
        color: #06d6a0;
    }
    .license-inactive {
        color: #ff7e5f;
    } 
    .transition-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(13, 27, 42, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s;
    }
    .transition-overlay.active {
        opacity: 1;
        pointer-events: all;
    }
    .transition-content {
        text-align: center;
        color: #ffd166;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(255, 209, 102, 0.7);
    }
    .transition-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(76, 161, 175, 0.3);
        border-top: 5px solid #4ca1af;
        border-radius: 50%;
        margin: 20px auto;
        animation: spin 1s linear infinite;
    }   
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
  
    .clickable-text {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .clickable-text:hover {
        fill: #ffd166 !important;
        font-size: 11px !important;
        text-shadow: 0 0 8px rgba(255, 209, 102, 0.7);
    }
    
    p {
display: block;
margin-block-start: 0.1em;
margin-block-end: 1em;
margin-inline-start: 0px;
margin-inline-end: 0px;
unicode-bidi: isolate;

}
.highlight {
color: #4ca1af;
font-weight: 600;
text-shadow: 0 0 8px rgba(76, 161, 175, 0.7);
}

.footer {
text-align: center;
margin-top: 20px;
padding: 20px;
background: rgba(255, 255, 255, 0.05);
border-radius: 15px;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
color: #a8dadc;
font-size: 1.1rem;
border: 1px solid rgba(76, 161, 175, 0.3);
max-width: 800px;
margin-left: auto;
margin-right: auto;
}
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
        .header h1 {
            font-size: 2rem;
        }
        
        .header h2 {
            font-size: 1.5rem;
        }
        
        .header p {
            font-size: 1rem;
        }
        
        .map-container {
            height: 70vh;
        }
        
        .center-circle {
            width: 120px;
            height: 120px;
        }
        
        .center-circle h3 {
            font-size: 1.2rem;
        }
        
        .center-circle p {
            font-size: 0.5rem;
        }
        
        .title-box {
            font-size: 1rem;
            padding: 8px 15px;
        }
        
        .sector-label {
            font-size: 16px;
        }
        
        .inner-label {
            font-size: 11px;
        }
        
        .subsection-label {
            font-size: 8px;
        }
    }
    
    @media (max-width: 480px) {
        .map-container {
            height: 60vh;
        }
        
        .center-circle {
            width: 70px;
            height: 70px;
        }
        
        .center-circle h3 {
            font-size: 8px;
        }
        
        .inner-label {
            font-size: 10px;
        }
        
        .subsection-label {
            font-size: 6px;
        }
    }

</style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="title-row">
        <div class="title-box">Question Support</div>
        <div class="title-box">Strategy Syria</div>
    </div>
    <div class="header">
        <h1>خريطة منظومة الابتكار في سوريا</h1>
        <h2>Startup Syria</h2>
        <p>نظام إدارة متكامل مع تأثيرات انتقالية متقدمة</p>
    </div>
    <div class="license-control">
        <input type="password" class="license-input" id="license-input" placeholder="أدخل مفتاح الترخيص">
        <button class="license-btn" id="license-btn">تفعيل الترخيص</button>
    </div>
    <div class="license-status" id="license-status">
        <span class="license-inactive"><i class="fas fa-times-circle"></i> الترخيص غير مفعل</span>
    </div>
    
    <div class="controls">
        <button class="control-btn" id="reset-view">
            <i class="fas fa-sync-alt"></i> إعادة تعيين العرض
        </button>
        <button class="control-btn" id="add-section">
            <i class="fas fa-plus-circle"></i> إضافة قسم جديد
        </button>
        <button class="control-btn" id="edit-section">
            <i class="fas fa-edit"></i> تعديل الأقسام
        </button>
        <div class="rotation-controls" id="rotation-controls">
            <div class="rotation-btn" id="rotate-left" title="تدوير لليسار">
                <i class="fas fa-undo"></i>
            </div>
            <div class="rotation-btn" id="rotate-right" title="تدوير لليمين">
                <i class="fas fa-redo"></i>
            </div>
        </div>
    </div>
    
    <div class="map-container">
        <div class="transition-overlay" id="transition-overlay">
            <div class="transition-content">
                <div class="transition-spinner"></div>
                <div>جاري تحميل البيانات...</div>
            </div>
        </div>
        <div id="concentric-map"></div>
        <div class="center-circle">
            <h3>سوريا</h3>
            <p>المركز الرئيسي</p>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-text">
                <h3 id="notification-title">تمت العملية بنجاح!</h3>
                <p id="notification-message">تم إضافة قسم جديد بنجاح</p>
            </div>
        </div>
    </div>
    
    <div class="statistics">
        <div class="stat-box">
            <div class="stat-value">42</div>
            <div class="stat-label">منظمة داعمة</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">18</div>
            <div class="stat-label">حاضنة أعمال</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">127</div>
            <div class="stat-label">مشروع ناشئ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">$5.2M</div>
            <div class="stat-label">استثمارات</div>
        </div>
    </div>
    <div class="footer">
        <div class="database-info">
            <i class="fas fa-database db-icon"></i>
            <span>جميع التغييرات محفوظة في قاعدة البيانات المحلية - آخر حفظ: <span id="last-save-time">لم يتم الحفظ بعد</span></span>
        </div>
        <p>Source: <span class="highlight">Data Collected by Startup Syria 2025</span></p>
    </div>
    
    <div class="modal" id="add-section-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة قسم جديد</h3>
                <button class="close-btn" id="close-add-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label for="new-section-name">اسم القسم الجديد</label>
                <input type="text" id="new-section-name" placeholder="أدخل اسم القسم الجديد هنا">
            </div>
            <div class="form-group">
                <label for="section-link">رابط القسم (اختياري)</label>
                <input type="url" id="section-link" placeholder="https://example.com">
            </div>
            <div class="form-actions">
                <button class="form-btn secondary" id="cancel-add-btn">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="form-btn primary" id="confirm-add-btn">
                    <i class="fas fa-plus"></i> إضافة القسم
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="edit-section-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل الأقسام</h3>
                <button class="close-btn" id="close-edit-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label for="section-select">اختر القسم للتعديل</label>
                <div class="section-list" id="section-list"></div>
            </div>
            <div class="form-group">
                <label for="edit-section-content">اسم القسم الجديد</label>
                <input type="text" id="edit-section-content" placeholder="أدخل الاسم الجديد للقسم">
            </div>
            <div class="form-group">
                <label for="edit-section-link">رابط القسم</label>
                <input type="url" id="edit-section-link" placeholder="https://example.com">
            </div>
            <div class="form-actions">
                <button class="form-btn secondary" id="cancel-edit-btn">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="form-btn primary" id="confirm-edit-btn">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // تكوين Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyAFwUMYczS1GbGzfa56blHRpS6hjY30DL8",
                authDomain: "startup-syria-map.firebaseapp.com",
                projectId: "startup-syria-map",
                storageBucket: "startup-syria-map.appspot.com",
                messagingSenderId: "190890951419",
                appId: "1:190890951419:web:dd712fbbca9c20ba31a65e",
                databaseURL: "https://startup-syria-map-default-rtdb.firebaseio.com"
            };
            
            // تهيئة Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            
            const width = 800;
            const height = 800;
            const centerX = width / 2;
            const centerY = height / 2;
            const svg = d3.select("#concentric-map")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            
            
            const rings = [
                { id: 1, innerRadius: 50, outerRadius: 150, name: "الحلقة الداخلية", color: "rgba(76, 161, 175, 0.3)" },
                { id: 2, innerRadius: 150, outerRadius: 350, name: "الحلقة الخارجية", color: "rgba(255, 126, 95, 0.3)" }
            ];
            
            const sectors = [
                { 
                    id: 1, 
                    name: "التمويل والاستثمار", 
                    color: "#ff7e5f", 
                    startAngle: 0, 
                    endAngle: 2*Math.PI/5, 
                    subsections: [
                        "Seed Funding",
                        "Venture Capital",
                        "Angel Investors",
                        "Crowdfunding",
                        "Islamic Finance",
                        "Growth Capital",
                        "IPO Support"
                    ]
                },
                { 
                    id: 2, 
                    name: "التعليم والبحث", 
                    color: "#4ca1af", 
                    startAngle: 2*Math.PI/5, 
                    endAngle: 4*Math.PI/5, 
                    subsections: [
                        "STEM Education",
                        "University Programs",
                        "Vocational Training",
                        "Tech Bootcamps",
                        "R&D Centers",
                        "Innovation Labs"
                    ]
                },
                { 
                    id: 3, 
                    name: "البنية التحتية", 
                    color: "#ffd166", 
                    startAngle: 4*Math.PI/5, 
                    endAngle: 6*Math.PI/5, 
                    subsections: [
                        "Co-working Spaces",
                        "Tech Incubators",
                        "Manufacturing Hubs"
                    ]
                },
                { 
                    id: 4, 
                    name: "الدعم والاستشارات", 
                    color: "#06d6a0", 
                    startAngle: 6*Math.PI/5, 
                    endAngle: 8*Math.PI/5, 
                    subsections: [
                        "Legal Support",
                        "Marketing Strategy",
                        "Mentorship",
                        "Business Planning"
                    ]
                },
                { 
                    id: 5, 
                    name: "السياسات والتنظيم", 
                    color: "#9d4edd", 
                    startAngle: 8*Math.PI/5, 
                    endAngle: 2*Math.PI, 
                    subsections: [
                        "Regulatory Framework",
                        "Tax Incentives",
                        "Startup Licenses",
                        "Export Policies",
                        "Labor Regulations",
                        "Compliance",
                        "Environmental Standards"
                    ]
                }
            ];
            
            let activeSection = null;
            let rotationAngle = 0;
            let sectionCount = 8;
            let sectionDatabase = {};
            let nestingLevel = 0;
            const MAX_NESTING_LEVEL = 1;
            let licenseActive = false;
            
            const licenseInput = document.getElementById('license-input');
            const licenseBtn = document.getElementById('license-btn');
            const licenseStatus = document.getElementById('license-status');
            const lastSaveTimeElement = document.getElementById('last-save-time');
            
           
            function updateLastSaveTime() {
                const now = new Date();
                lastSaveTimeElement.textContent = now.toLocaleTimeString('ar-SA');
            }
            
            
            function loadLicenseStatus() {
                const savedLicense = localStorage.getItem('innovationMapLicense');
                if (savedLicense) {
                    try {
                        const licenseData = JSON.parse(savedLicense);
                        licenseActive = licenseData.active || false;
                    } catch (error) {
                        console.error('Error loading license status:', error);
                        licenseActive = false;
                    }
                }
            }
            
            // حفظ حالة الترخيص في localStorage
            function saveLicenseStatus() {
                try {
                    const licenseData = {
                        active: licenseActive,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('innovationMapLicense', JSON.stringify(licenseData));
                } catch (error) {
                    console.error('Error saving license status:', error);
                }
            }
            
            function updateLicenseUI() {
                if (licenseActive) {
                    licenseStatus.innerHTML = '<span class="license-active"><i class="fas fa-check-circle"></i> الترخيص مفعل</span>';
                    document.getElementById('add-section').style.display = 'flex';
                    document.getElementById('edit-section').style.display = 'flex';
                } else {
                    licenseStatus.innerHTML = '<span class="license-inactive"><i class="fas fa-times-circle"></i> الترخيص غير مفعل</span>';
                    document.getElementById('add-section').style.display = 'none';
                    document.getElementById('edit-section').style.display = 'none';
                }
            }
            
            async function verifyLicenseKey(key) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const hashedKey = CryptoJS.SHA256(key).toString();
                        const validKeys = [
                            "42281dc0e8dbaab0cded0057f015964d8738477fdcd4c25480b4a95bdb6c0f4b", // "startup-syria-2025"
                            "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3", // "hello"
                            "ef2d127de37b942baad06145e54b0c619a1f22327b2ebbcfbec78f5564afe39d"  // "test123"
                        ];
                        resolve(validKeys.includes(hashedKey));
                    }, 500);
                });
            }
            
            licenseBtn.addEventListener('click', async function() {
                const enteredKey = licenseInput.value.trim();
                
                if (!enteredKey) {
                    showNotification('خطأ في الإدخال', 'يرجى إدخال مفتاح الترخيص');
                    return;
                }
                
                
                licenseStatus.innerHTML = '<span><i class="fas fa-spinner fa-spin"></i> جاري التحقق من الترخيص...</span>';
                
                try {
                    const isValid = await verifyLicenseKey(enteredKey);
                    
                    if (isValid) {
                        licenseActive = true;
                        saveLicenseStatus(); // حفظ حالة الترخيص
                        licenseInput.value = ''; // مسح الحقل بعد التفعيل الناجح
                        showNotification('تم التفعيل بنجاح!', 'تم تفعيل الترخيص بنجاح');
                    } else {
                        licenseActive = false;
                        showNotification('خطأ في الترخيص', 'مفتاح الترخيص غير صحيح');
                    }
                } catch (error) {
                    console.error("License verification error:", error);
                    licenseActive = false;
                    showNotification('خطأ في النظام', 'فشل التحقق من الترخيص، يرجى المحاولة لاحقاً');
                }
                
                updateLicenseUI();
            });    
            
            
            async function loadData() {
                try {
                    
                    const localData = localStorage.getItem('innovationMapData');
                    if (localData) {
                        try {
                            const parsedData = JSON.parse(localData);
                            sectionDatabase = parsedData.data || parsedData;
                            ensureAllSectionsExist();
                            console.log('تم تحميل البيانات من التخزين المحلي');
                            
                           
                            if (parsedData.timestamp) {
                                const saveDate = new Date(parsedData.timestamp);
                                lastSaveTimeElement.textContent = saveDate.toLocaleTimeString('ar-SA');
                            }
                        } catch (error) {
                            console.error('خطأ في تحليل البيانات المحلية:', error);
                            initializeDatabase();
                        }
                    } else {
                        
                        try {
                            const snapshot = await database.ref('innovationMapData').once('value');
                            if (snapshot.exists()) {
                                sectionDatabase = snapshot.val();
                                ensureAllSectionsExist();
                                // حفظ البيانات محلياً كنسخة احتياطية
                                saveDataLocally();
                                console.log('تم تحميل البيانات من Firebase');
                            } else {
                                initializeDatabase();
                                console.log('تم إنشاء بيانات جديدة');
                            }
                        } catch (firebaseError) {
                            console.error('خطأ في تحميل البيانات من Firebase:', firebaseError);
                            initializeDatabase();
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error("خطأ عام في تحميل البيانات:", error);
                    initializeDatabase();
                    return false;
                }
            }
            
            
            function ensureAllSectionsExist() {
                let hasChanges = false;
                sectors.forEach(sector => {
                    sector.subsections.forEach(subsection => {
                        if (!sectionDatabase[subsection]) {
                            
                            sectionDatabase[subsection] = {
                                sectionNames: Array.from({length: sectionCount}, (_, i) => `القسم ${i+1}`),
                                sectionLinks: Array(sectionCount).fill(''),
                                sectorColor: sector.color
                            };
                            hasChanges = true;
                        }
                    });
                });
                
                if (hasChanges) {
                    saveData(); 
                }
            }
            
            
            function saveDataLocally() {
                try {
                    const dataToSave = {
                        data: sectionDatabase,
                        timestamp: Date.now(),
                        version: '1.0'
                    };
                    localStorage.setItem('innovationMapData', JSON.stringify(dataToSave));
                    updateLastSaveTime();
                    console.log('تم حفظ البيانات محلياً');
                    return true;
                } catch (error) {
                    console.error('خطأ في الحفظ المحلي:', error);
                    return false;
                }
            }
            
            
            async function saveData() {
                try {
                  
                    const localSaved = saveDataLocally();
                    
                   
                    try {
                        await database.ref('innovationMapData').set(sectionDatabase);
                        console.log('تم حفظ البيانات في Firebase');
                        return true;
                    } catch (firebaseError) {
                        console.error("خطأ في حفظ البيانات في Firebase:", firebaseError);
                        // إذا فشل Firebase، على الأقل البيانات محفوظة محلياً
                        if (localSaved) {
                            showNotification('تم الحفظ محلياً', 'تم حفظ البيانات في التخزين المحلي فقط');
                            return true;
                        }
                        return false;
                    }
                } catch (error) {
                    console.error("خطأ عام في حفظ البيانات:", error);
                    return false;
                }
            }
            
            
            function setupRealtimeUpdates() {
                try {
                    database.ref('innovationMapData').on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const firebaseData = snapshot.val();
                            
                            if (JSON.stringify(firebaseData) !== JSON.stringify(sectionDatabase)) {
                                sectionDatabase = firebaseData;
                                ensureAllSectionsExist();
                                
                                
                                if (activeSection) {
                                    const sectorColor = sectionDatabase[activeSection]?.sectorColor || "#4ca1af";
                                    createNewCircleMap(activeSection, sectorColor);
                                } else {
                                    drawMap();
                                }
                                
                               
                                saveDataLocally();
                                console.log('تم تحديث البيانات من Firebase');
                            }
                        }
                    });
                } catch (error) {
                    console.error('خطأ في إعداد التحديثات المباشرة:', error);
                }
            }
            
            function initializeDatabase() {
                sectors.forEach(sector => {
                    sector.subsections.forEach(subsection => {
                        sectionDatabase[subsection] = {
                            sectionNames: Array.from({length: sectionCount}, (_, i) => `القسم ${i+1}`),
                            sectionLinks: Array(sectionCount).fill(''),
                            sectorColor: sector.color
                        };
                    });
                });
                
                saveData();
            }
            
            function drawMap() {
                svg.selectAll("*").remove();
                rings.forEach(ring => {
                    sectors.forEach(sector => {
                        const startAngle = sector.startAngle + rotationAngle;
                        const endAngle = sector.endAngle + rotationAngle;
                        if (ring.id === 2) {
                            const sectorAngleRange = endAngle - startAngle;
                            const subsectionAngle = sectorAngleRange / sector.subsections.length;
                            for (let i = 0; i < sector.subsections.length; i++) {
                                const subsectionName = sector.subsections[i];
                                const subsectionStartAngle = startAngle + i * subsectionAngle;
                                const subsectionEndAngle = subsectionStartAngle + subsectionAngle;
                                const arcGenerator = d3.arc()
                                    .innerRadius(ring.innerRadius)
                                    .outerRadius(ring.outerRadius)
                                    .startAngle(subsectionStartAngle)
                                    .endAngle(subsectionEndAngle);
                                const path = svg.append("path")
                                    .attr("d", arcGenerator())
                                    .attr("transform", `translate(${centerX}, ${centerY})`)
                                    .attr("fill", sector.color)
                                    .attr("stroke", "white")
                                    .attr("stroke-width", 1)
                                    .attr("opacity", 0.8)
                                    .attr("class", "subsection")
                                    .attr("data-sector", sector.id)
                                    .attr("data-subsection", i)
                                    .on("mouseover", function() {
                                        d3.select(this).attr("opacity", 1);
                                    })
                                    .on("mouseout", function() {
                                        d3.select(this).attr("opacity", 0.8);
                                    });
                                if (nestingLevel === 0) {
                                    path.on("click", function() {
                                        nestingLevel++;  
                                        const sectorColor = sector.color;
                                        createNewCircleMap(subsectionName, sectorColor);
                                    });
                                }
                                const middleAngle = subsectionStartAngle + subsectionAngle / 2;
                                const textRadius = (ring.innerRadius + ring.outerRadius) / 2;
                                const correctedAngle = middleAngle + 4.728;
                                const x = centerX + textRadius * Math.cos(correctedAngle);
                                const y = centerY + textRadius * Math.sin(correctedAngle);
                                let rotation = (middleAngle * 180 / Math.PI) + 89;
                                if (rotation > 90 && rotation < 270) {
                                    rotation += 180;
                                }
                                const g = svg.append("g")
                                    .attr("transform", `translate(${x}, ${y}) rotate(${rotation})`)
                                    .attr("class", "subsection-label");
                                const labelText = subsectionName;
                                const maxCharsPerLine = 12;
                                let lines = [];
                                if (labelText.length > maxCharsPerLine) {
                                    const words = labelText.split(' ');
                                    let line = "";
                                    words.forEach(word => {
                                        if ((line + word).length <= maxCharsPerLine) {
                                            line += (line ? " " : "") + word;
                                        } else {
                                            lines.push(line);
                                            line = word;
                                        }
                                    });
                                    if (line) lines.push(line);
                                } else {
                                    lines = [labelText];
                                }
                                const lineHeight = 12;
                                const startY = -((lines.length - 1) * lineHeight) / 2;
                                lines.forEach((line, index) => {
                                    g.append("text")
                                        .attr("x", 0)
                                        .attr("y", startY + index * lineHeight)
                                        .attr("text-anchor", "middle")
                                        .attr("dy", "0.35em")
                                        .attr("fill", "#ffffff")
                                        .attr("font-size", "10px")
                                        .attr("font-weight", "bold")
                                        .text(line);
                                });
                            }
                        } else {
                            const arcGenerator = d3.arc()
                                .innerRadius(ring.innerRadius)
                                .outerRadius(ring.outerRadius)
                                .startAngle(startAngle)
                                .endAngle(endAngle);
                            const path = svg.append("path")
                                .attr("d", arcGenerator())
                                .attr("transform", `translate(${centerX}, ${centerY})`)
                                .attr("fill", sector.color)
                                .attr("stroke", "white")
                                .attr("stroke-width", 1)
                                .attr("opacity", 0.8)
                                .attr("class", "sector")
                                .attr("data-sector", sector.id)
                                .on("mouseover", function() {
                                    d3.select(this).attr("opacity", 1);
                                })
                                .on("mouseout", function() {
                                    d3.select(this).attr("opacity", 0.8);
                                });
                        }
                    });
                });
                const innerLabels = [
                    { 
                        lines: ["Regulations and", "Government Support"], 
                        color: "#4ca1af",
                        angle: Math.PI * 0.5 + rotationAngle
                    },
                    { 
                        lines: ["Ideation Support"],
                        color: "#06d6a0",
                        angle: Math.PI * 1.7 + rotationAngle
                    },
                    { 
                        lines: ["Networking and", "Cultures"],
                        color: "#ff7e5f",
                        angle: Math.PI * 0.9 + rotationAngle
                    },
                    { 
                        lines: ["Operation, Growth", "and Markets"],
                        color: "#9d4edd",
                        angle: Math.PI * 0.1 + rotationAngle
                    },
                    { 
                        lines: ["Funding"],
                        color: "#ffd166",
                        angle: Math.PI * 3.3 + rotationAngle
                    }
                ];
                const innerRadius = 100;
                innerLabels.forEach((label) => {
                    const x = centerX + innerRadius * Math.cos(label.angle);
                    const y = centerY + innerRadius * Math.sin(label.angle);
                    let rotation = (label.angle * 180 / Math.PI) + 90;
                    if (rotation > 90 && rotation < 270) {
                        rotation += 180;
                    }
                    const g = svg.append("g")
                        .attr("transform", `translate(${x}, ${y}) rotate(${rotation})`)
                        .attr("class", "inner-label");               
     const lineHeight = 15;
                    const startY = -((label.lines.length - 1) * lineHeight) / 2;
                    label.lines.forEach((line, i) => {
                        if (line === "Funding") {
                            g.append("text")
                                .attr("x", 0)
                                .attr("y", startY + i * lineHeight - 4)
                                .attr("text-anchor", "middle")
                                .attr("dy", "0.35em")
                                .attr("fill", label.color)
                                .attr("font-size", "15px")
                                .attr("font-weight", "bold")
                                .text(line);
                        } else {
                            g.append("text")
                                .attr("x", 0)
                                .attr("y", startY + i * lineHeight)
                                .attr("text-anchor", "middle")
                                .attr("dy", "0.35em")
                                .attr("fill", label.color)
                                .attr("font-size", "13px")
                                .attr("font-weight", "bold")
                                .text(line);
                        }
                    });
                });
            }
            function createNewCircleMap(subsectionName, sectorColor) {
                const transitionOverlay = document.getElementById('transition-overlay');
                transitionOverlay.classList.add('active');
                setTimeout(() => {
                    svg.selectAll("*").remove();
                    document.querySelector('.center-circle').innerHTML = `
                        <h3>${subsectionName}</h3>
                    `; 
                    document.getElementById('rotation-controls').style.display = 'none';
                    const currentData = sectionDatabase[subsectionName];    
                    if (!currentData) {
                        console.warn("إنشاء بيانات جديدة للقسم:", subsectionName); 
                        const parentSector = sectors.find(sector => 
                            sector.subsections.includes(subsectionName)
                        );
                        sectionDatabase[subsectionName] = {
                            sectionNames: Array.from({length: sectionCount}, (_, i) => `القسم ${i+1}`),
                            sectionLinks: Array(sectionCount).fill(''),
                            sectorColor: parentSector ? parentSector.color : "#4ca1af"
                        }; 
                        saveData();
                    }
                    const sectionNames = sectionDatabase[subsectionName].sectionNames;
                    const sectionLinks = sectionDatabase[subsectionName].sectionLinks;
                    const sectorAngle = (2 * Math.PI) / sectionNames.length;
                    for (let i = 0; i < sectionNames.length; i++) {
                        const startAngle = i * sectorAngle;
                        const endAngle = (i + 1) * sectorAngle;
                        const color = sectionDatabase[subsectionName].sectorColor;
                        const arcGenerator = d3.arc()
                            .innerRadius(50) // من المركز مباشرة
                            .outerRadius(350) // إلى الحافة الخارجية
                            .startAngle(startAngle)
                            .endAngle(endAngle);
                        const path = svg.append("path")
                            .attr("d", arcGenerator())
                            .attr("transform", `translate(${centerX}, ${centerY})`)
                            .attr("fill", color)
                            .attr("stroke", "white")
                            .attr("stroke-width", 1)
                            .attr("opacity", 0.8)
                            .attr("class", "subsection-item")
                            .attr("data-section", i)
                            .on("mouseover", function() {
                                d3.select(this).attr("opacity", 1);
                            })
                            .on("mouseout", function() {
                                d3.select(this).attr("opacity", 0.8);
                            });     
                        if (sectionLinks[i]) {
                            path.on("click", function() {
                                window.open(sectionLinks[i], '_blank');
                            });
                        }
                        const middleAngle = startAngle + sectorAngle / 2;
                        const textRadius = 200;
                        const correctedAngle = middleAngle + 4.728;
                        const x = centerX + textRadius * Math.cos(correctedAngle);
                        const y = centerY + textRadius * Math.sin(correctedAngle);
                        let rotation = (middleAngle * 180 / Math.PI) + 90;
                        if (rotation > 90 && rotation < 270) {
                            rotation += 180;
                        }
                        const g = svg.append("g")
                            .attr("transform", `translate(${x}, ${y}) rotate(${rotation})`)
                            .attr("class", "subsection-label");
                        const text = g.append("text")
                            .attr("x", 0)
                            .attr("y", 0)
                            .attr("text-anchor", "middle")
                            .attr("dy", "0.35em")
                            .attr("font-size", "10px")
                            .attr("font-weight", "bold")
                            .text(sectionNames[i]);
                        if (sectionLinks[i]) {
                            text.attr("fill", "#ffd166")
                                .attr("class", "clickable-text")
                                .on("click", function() {
                                    window.open(sectionLinks[i], '_blank');
                                });
                        } else {
                            text.attr("fill", "#ffffff");
                        }
                    } 
                    svg.append("circle")
                        .attr("cx", centerX)
                        .attr("cy", centerY)
                        .attr("r", 350)
                        .attr("fill", "none")
                        .attr("stroke", "rgba(255, 255, 255, 0.2)")
                        .attr("stroke-dasharray", "5,5")
                        .attr("stroke-width", 1);      
                    const innerText = svg.append("text")
                        .attr("x", centerX)
                        .attr("y", centerY)
                        .attr("text-anchor", "middle")
                        .attr("dy", "0.35em")
                        .attr("fill", "#ffd166")
                        .attr("font-size", "16px")
                        .attr("font-weight", "bold")
                        .text("أقسام جديدة");
                    activeSection = subsectionName;
                    setTimeout(() => {
                        transitionOverlay.classList.remove('active');
                    }, 500);
                }, 800);
            }
            function transitionBackToMain() {
                const transitionOverlay = document.getElementById('transition-overlay');
                transitionOverlay.classList.add('active');
                setTimeout(() => {
                    svg.selectAll("*").remove();
                    nestingLevel = 0;
                    rotationAngle = 0;
                    drawMap();
                    document.getElementById('rotation-controls').style.display = 'flex';
                    document.querySelector('.center-circle').innerHTML = `
                        <h3>سوريا</h3>
                        <p>المركز الرئيسي</p>
                    `;
                    activeSection = null;
                    setTimeout(() => {
                        transitionOverlay.classList.remove('active');
                    }, 500);
                }, 800);
            }     
            
            
            loadLicenseStatus();
            await loadData();
            setupRealtimeUpdates();
            updateLicenseUI();
            drawMap();
            
            
            window.addEventListener('beforeunload', function() {
                saveDataLocally(); 
            });
            
            
            setInterval(() => {
                if (Object.keys(sectionDatabase).length > 0) {
                    saveDataLocally();
                }
            }, 30000);
            
            document.querySelector('.center-circle').addEventListener('click', function() {
                transitionBackToMain();
            });
            document.getElementById('reset-view').addEventListener('click', function() {
                transitionBackToMain();
            });
            document.getElementById('rotate-left').addEventListener('click', function() {
                rotationAngle -= Math.PI/4;
                drawMap();
            });
            
            document.getElementById('rotate-right').addEventListener('click', function() {
                rotationAngle += Math.PI/4;
                drawMap();
            });
            document.getElementById('add-section').addEventListener('click', function() {
                if (!licenseActive) {
                    showNotification('خطأ في الترخيص', 'يجب تفعيل الترخيص أولاً');
                    return;
                }
                if (!activeSection) {
                    showNotification('خطأ', 'يجب اختيار قسم فرعي أولاً');
                    return;
                }
                document.getElementById('add-section-modal').classList.add('active');
                document.getElementById('new-section-name').value = '';
                document.getElementById('section-link').value = '';
                document.getElementById('new-section-name').focus();
            });
            document.getElementById('edit-section').addEventListener('click', function() {
                if (!licenseActive) {
                    showNotification('خطأ في الترخيص', 'يجب تفعيل الترخيص أولاً');
                    return;
                }
                if (!activeSection) {
                    showNotification('خطأ', 'يجب اختيار قسم فرعي أولاً');
                    return;
                }
                updateSectionList();
                document.getElementById('edit-section-modal').classList.add('active');
                document.getElementById('edit-section-content').value = '';
                document.getElementById('edit-section-link').value = '';
                document.querySelectorAll('.section-item').forEach(item => {
                    item.classList.remove('active');
                });
            });
            document.getElementById('close-add-modal').addEventListener('click', function() {
                document.getElementById('add-section-modal').classList.remove('active');
            });
            document.getElementById('cancel-add-btn').addEventListener('click', function() {
                document.getElementById('add-section-modal').classList.remove('active');
            });
            document.getElementById('confirm-add-btn').addEventListener('click', async function() {
                const newName = document.getElementById('new-section-name').value.trim();
                const newLink = document.getElementById('section-link').value.trim();
                if (newName) {
                    if (!sectionDatabase[activeSection]) {
                        sectionDatabase[activeSection] = {
                            sectionNames: [],
                            sectionLinks: [],
                            sectorColor: "#4ca1af"
                        };
                    }
                    sectionDatabase[activeSection].sectionNames.push(newName);
                    sectionDatabase[activeSection].sectionLinks.push(newLink);
                    if (activeSection) {
                        
                        const sectorColor = sectionDatabase[activeSection].sectorColor;
                       
                        const saved = await saveData();
                        if (saved) {
                            createNewCircleMap(activeSection, sectorColor);
                            showNotification('تمت الإضافة بنجاح!', `تم إضافة قسم جديد باسم: ${newName}`);
                        } else {
                            showNotification('خطأ في الحفظ', 'فشل في حفظ القسم الجديد');
                        }
                    }
                    document.getElementById('add-section-modal').classList.remove('active');
                } else {
                    alert('الرجاء إدخال اسم للقسم الجديد');
                }
            });
            document.getElementById('close-edit-modal').addEventListener('click', function() {
                document.getElementById('edit-section-modal').classList.remove('active');
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', function() {
                document.getElementById('edit-section-modal').classList.remove('active');
            });
            document.getElementById('confirm-edit-btn').addEventListener('click', async function() {
                const selectedItem = document.querySelector('.section-item.active');
                const newName = document.getElementById('edit-section-content').value.trim();
                const newLink = document.getElementById('edit-section-link').value.trim();
                if (!selectedItem) {
                    alert('الرجاء تحديد قسم للتعديل');
                    return;
                }
                if (!newName) {
                    alert('الرجاء إدخال اسم جديد للقسم');
                    return;
                }
                const sectionId = parseInt(selectedItem.dataset.id);
                sectionDatabase[activeSection].sectionNames[sectionId] = newName;
                sectionDatabase[activeSection].sectionLinks[sectionId] = newLink;
                if (activeSection) {
                    
                    const sectorColor = sectionDatabase[activeSection].sectorColor;
                    
                    const saved = await saveData();
                    if (saved) {
                        createNewCircleMap(activeSection, sectorColor);
                        showNotification('تم التعديل بنجاح!', `تم تحديث القسم رقم ${sectionId + 1} بنجاح`);
                    } else {
                        showNotification('خطأ في الحفظ', 'فشل في حفظ التعديلات');
                    }
                }
                document.getElementById('edit-section-modal').classList.remove('active');
            });
            function showNotification(title, message) {
                const notification = document.getElementById('notification');
                const titleElement = document.getElementById('notification-title');
                const messageElement = document.getElementById('notification-message');
                titleElement.textContent = title;
                messageElement.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            function updateSectionList() {
                const sectionList = document.getElementById('section-list');
                sectionList.innerHTML = '';
                if (!activeSection) return;
                const sectionNames = sectionDatabase[activeSection].sectionNames;
                const sectionLinks = sectionDatabase[activeSection].sectionLinks;
                sectionNames.forEach((name, index) => {
                    const sectionItem = document.createElement('div');
                    sectionItem.className = 'section-item';
                    sectionItem.dataset.id = index;
                    sectionItem.innerHTML = `
                        <div>
                            <span class="section-name">${name}</span>
                            ${sectionLinks[index] ? 
                                `<span class="section-link"><i class="fas fa-link link-icon"></i> ${sectionLinks[index]}</span>` : 
                                ''}
                        </div>
                        <span class="section-id">${index + 1}</span>
                    `;
                    sectionItem.addEventListener('click', function() {
                        document.querySelectorAll('.section-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                        document.getElementById('edit-section-content').value = name;
                        document.getElementById('edit-section-link').value = sectionLinks[index] || '';
                    });
                    sectionList.appendChild(sectionItem);
                });
            }
        });
    </script>
</body>
</html>

